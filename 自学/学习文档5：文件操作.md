# 学习文档5：文件操作

## 1. 文件操作概述

文件操作是Python编程中的重要部分，用于读取和写入数据到文件中。Python提供了简单易用的文件操作API，可以处理各种类型的文件。

**文件操作的基本流程**：
1. 打开文件：使用`open()`函数打开文件，获取文件对象
2. 操作文件：读取或写入数据
3. 关闭文件：使用`close()`方法关闭文件，释放资源

## 2. 文件的打开与关闭

### 2.1 打开文件
使用`open()`函数打开文件，返回一个文件对象。

**语法**：
```python
open(file, mode='r', buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None)
```

**主要参数**：
- `file`：文件名或文件路径
- `mode`：文件打开模式，默认值为`'r'`（只读）
- `encoding`：文件编码，如`'utf-8'`、`'gbk'`等

**文件打开模式**：

| 模式 | 描述 |
|------|------|
| `r` | 只读模式（默认），文件必须存在 |
| `w` | 写入模式，会覆盖已有文件，文件不存在则创建 |
| `a` | 追加模式，在文件末尾追加内容，文件不存在则创建 |
| `x` | 独占创建模式，文件不存在则创建，存在则报错 |
| `b` | 二进制模式，用于处理二进制文件（如图片、音频等） |
| `t` | 文本模式（默认），用于处理文本文件 |
| `+` | 读写模式，与其他模式结合使用 |

**常见的模式组合**：
- `'rt'` 或 `'r'`：只读文本模式（默认）
- `'wt'` 或 `'w'`：只写文本模式
- `'at'` 或 `'a'`：追加文本模式
- `'rb'`：只读二进制模式
- `'wb'`：只写二进制模式
- `'ab'`：追加二进制模式
- `'r+'`：读写文本模式
- `'w+'`：读写文本模式（会覆盖已有文件）
- `'a+'`：读写文本模式（在文件末尾追加）

**示例**：
```python
# 打开文本文件，只读模式
file = open("test.txt", "r", encoding="utf-8")

# 打开文本文件，写入模式
file = open("test.txt", "w", encoding="utf-8")

# 打开文本文件，追加模式
file = open("test.txt", "a", encoding="utf-8")

# 打开二进制文件，只读模式
file = open("image.jpg", "rb")

# 打开二进制文件，写入模式
file = open("image.jpg", "wb")
```

### 2.2 关闭文件
使用文件对象的`close()`方法关闭文件，释放系统资源。

**示例**：
```python
# 打开文件
file = open("test.txt", "r", encoding="utf-8")

# 操作文件
content = file.read()
print(content)

# 关闭文件
file.close()
```

**注意事项**：
- 打开文件后必须关闭，否则会导致资源泄漏
- 关闭文件后，文件对象不能再被使用
- 如果在文件操作过程中发生异常，可能会导致文件无法关闭

### 2.3 with语句
`with`语句用于自动管理文件资源，无论是否发生异常，都会自动关闭文件。

**语法**：
```python
with open(file, mode, encoding) as file_object:
    # 操作文件
```

**示例**：
```python
# 使用with语句打开文件
with open("test.txt", "r", encoding="utf-8") as file:
    content = file.read()
    print(content)
# 文件会自动关闭
```

**优点**：
- 自动关闭文件，避免资源泄漏
- 代码更简洁，可读性更好
- 可以处理异常，确保文件关闭

## 3. 文件的读取

### 3.1 读取整个文件
使用`read()`方法读取整个文件的内容。

**示例**：
```python
# 读取整个文件
with open("test.txt", "r", encoding="utf-8") as file:
    content = file.read()
    print(content)
```

### 3.2 读取指定字节数
使用`read(size)`方法读取指定字节数的内容。

**示例**：
```python
# 读取指定字节数
with open("test.txt", "r", encoding="utf-8") as file:
    content1 = file.read(10)  # 读取前10个字符
    content2 = file.read(10)  # 读取接下来的10个字符
    print(content1)
    print(content2)
```

### 3.3 逐行读取
使用`readline()`方法逐行读取文件内容，使用`readlines()`方法读取所有行并返回一个列表。

**示例**：
```python
# 逐行读取 - readline()
with open("test.txt", "r", encoding="utf-8") as file:
    line1 = file.readline()  # 读取第一行
    line2 = file.readline()  # 读取第二行
    print(line1, end="")  # end="" 避免重复换行
    print(line2, end="")

# 逐行读取 - for循环
with open("test.txt", "r", encoding="utf-8") as file:
    for line in file:
        print(line, end="")

# 读取所有行 - readlines()
with open("test.txt", "r", encoding="utf-8") as file:
    lines = file.readlines()  # 返回包含所有行的列表
    print(lines)  # 输出列表
    for line in lines:
        print(line, end="")
```

## 4. 文件的写入

### 4.1 写入字符串
使用`write()`方法写入字符串到文件中。

**示例**：
```python
# 写入字符串
with open("test.txt", "w", encoding="utf-8") as file:
    file.write("Hello, World!\n")
    file.write("This is a test file.\n")
    file.write("Python file operations.\n")
```

### 4.2 写入列表
使用`writelines()`方法写入列表到文件中，列表中的每个元素必须是字符串。

**示例**：
```python
# 写入列表
lines = ["Hello, World!\n", "This is a test file.\n", "Python file operations.\n"]
with open("test.txt", "w", encoding="utf-8") as file:
    file.writelines(lines)
```

## 5. 文件定位

### 5.1 获取当前位置
使用`tell()`方法获取文件指针的当前位置（字节偏移量）。

**示例**：
```python
# 获取当前位置
with open("test.txt", "r", encoding="utf-8") as file:
    content1 = file.read(10)
    print(f"读取了{len(content1)}个字符")
    position = file.tell()
    print(f"当前位置：{position}")
    content2 = file.read(10)
    print(f"读取了{len(content2)}个字符")
    position = file.tell()
    print(f"当前位置：{position}")
```

### 5.2 移动文件指针
使用`seek(offset, whence)`方法移动文件指针到指定位置。

**参数说明**：
- `offset`：偏移量，正数表示向后移动，负数表示向前移动
- `whence`：起始位置，默认值为`0`
  - `0`：从文件开头开始计算
  - `1`：从当前位置开始计算
  - `2`：从文件末尾开始计算

**示例**：
```python
# 移动文件指针
with open("test.txt", "r", encoding="utf-8") as file:
    # 读取前10个字符
    content1 = file.read(10)
    print(content1)
    
    # 移动到文件开头
    file.seek(0)
    content2 = file.read(5)
    print(content2)
    
    # 从当前位置向后移动3个字符
    file.seek(3, 1)
    content3 = file.read(5)
    print(content3)
```

## 6. 文件操作示例

### 6.1 文本文件操作

**示例1：读取文本文件**
```python
# 读取文本文件
with open("test.txt", "r", encoding="utf-8") as file:
    content = file.read()
    print("文件内容：")
    print(content)
    print(f"文件长度：{len(content)}字符")
```

**示例2：写入文本文件**
```python
# 写入文本文件
with open("test.txt", "w", encoding="utf-8") as file:
    file.write("Python文件操作示例\n")
    file.write("1. 读取文件\n")
    file.write("2. 写入文件\n")
    file.write("3. 文件定位\n")
print("文件写入完成")
```

**示例3：追加文本到文件**
```python
# 追加文本到文件
with open("test.txt", "a", encoding="utf-8") as file:
    file.write("4. 文件关闭\n")
    file.write("5. with语句\n")
print("文件追加完成")
```

**示例4：复制文本文件**
```python
# 复制文本文件
source_file = "test.txt"
target_file = "test_copy.txt"

with open(source_file, "r", encoding="utf-8") as src:
    content = src.read()
    with open(target_file, "w", encoding="utf-8") as dst:
        dst.write(content)
print(f"文件{source_file}已复制到{target_file}")
```

### 6.2 二进制文件操作

**示例1：读取二进制文件**
```python
# 读取二进制文件
with open("image.jpg", "rb") as file:
    content = file.read()
    print(f"文件大小：{len(content)}字节")
```

**示例2：复制二进制文件**
```python
# 复制二进制文件
source_file = "image.jpg"
target_file = "image_copy.jpg"

with open(source_file, "rb") as src:
    with open(target_file, "wb") as dst:
        # 分块读取，提高效率
        while True:
            chunk = src.read(1024)  # 每次读取1024字节
            if not chunk:
                break
            dst.write(chunk)
print(f"二进制文件{source_file}已复制到{target_file}")
```

## 7. 文件和目录操作

### 7.1 os模块
`os`模块提供了与操作系统交互的功能，包括文件和目录操作。

**常用os模块函数**：

| 函数 | 描述 |
|------|------|
| `os.getcwd()` | 获取当前工作目录 |
| `os.chdir(path)` | 改变当前工作目录 |
| `os.listdir(path)` | 列出目录中的文件和子目录 |
| `os.mkdir(path)` | 创建单个目录 |
| `os.makedirs(path)` | 递归创建目录 |
| `os.remove(path)` | 删除文件 |
| `os.rmdir(path)` | 删除空目录 |
| `os.removedirs(path)` | 递归删除空目录 |
| `os.rename(src, dst)` | 重命名文件或目录 |
| `os.stat(path)` | 获取文件或目录的状态信息 |
| `os.path.exists(path)` | 检查文件或目录是否存在 |
| `os.path.isfile(path)` | 检查是否为文件 |
| `os.path.isdir(path)` | 检查是否为目录 |
| `os.path.join(path1, path2, ...)` | 连接路径 |
| `os.path.abspath(path)` | 获取绝对路径 |
| `os.path.basename(path)` | 获取文件名 |
| `os.path.dirname(path)` | 获取目录名 |
| `os.path.split(path)` | 分割路径为目录名和文件名 |
| `os.path.splitext(path)` | 分割路径为文件名和扩展名 |

**示例**：
```python
import os

# 获取当前工作目录
current_dir = os.getcwd()
print(f"当前工作目录：{current_dir}")

# 列出目录中的文件和子目录
files = os.listdir(current_dir)
print(f"目录内容：{files}")

# 检查文件是否存在
file_path = "test.txt"
if os.path.exists(file_path):
    print(f"文件{file_path}存在")
    if os.path.isfile(file_path):
        print(f"{file_path}是一个文件")
    elif os.path.isdir(file_path):
        print(f"{file_path}是一个目录")
else:
    print(f"文件{file_path}不存在")

# 创建目录
new_dir = "new_folder"
if not os.path.exists(new_dir):
    os.mkdir(new_dir)
    print(f"目录{new_dir}已创建")

# 重命名文件
old_name = "test.txt"
new_name = "test_rename.txt"
if os.path.exists(old_name):
    os.rename(old_name, new_name)
    print(f"文件{old_name}已重命名为{new_name}")

# 删除文件
if os.path.exists(new_name):
    os.remove(new_name)
    print(f"文件{new_name}已删除")

# 删除目录
if os.path.exists(new_dir):
    os.rmdir(new_dir)
    print(f"目录{new_dir}已删除")
```

### 7.2 shutil模块
`shutil`模块提供了高级文件操作功能，如复制、移动、压缩等。

**常用shutil模块函数**：

| 函数 | 描述 |
|------|------|
| `shutil.copy(src, dst)` | 复制文件 |
| `shutil.copy2(src, dst)` | 复制文件，保留元数据 |
| `shutil.copytree(src, dst)` | 递归复制目录 |
| `shutil.move(src, dst)` | 移动或重命名文件/目录 |
| `shutil.rmtree(path)` | 递归删除目录及其内容 |
| `shutil.make_archive(base_name, format, root_dir)` | 创建压缩文件 |

**示例**：
```python
import shutil
import os

# 复制文件
src_file = "test.txt"
dst_file = "test_copy.txt"
if os.path.exists(src_file):
    shutil.copy(src_file, dst_file)
    print(f"文件{src_file}已复制到{dst_file}")

# 复制目录
src_dir = "source_folder"
dst_dir = "destination_folder"
if os.path.exists(src_dir):
    shutil.copytree(src_dir, dst_dir)
    print(f"目录{src_dir}已复制到{dst_dir}")

# 移动文件
src_file = "test.txt"
dst_dir = "new_folder"
if os.path.exists(src_file) and os.path.exists(dst_dir):
    shutil.move(src_file, dst_dir)
    print(f"文件{src_file}已移动到{dst_dir}")

# 删除目录
if os.path.exists(dst_dir):
    shutil.rmtree(dst_dir)
    print(f"目录{dst_dir}已删除")
```

## 8. 实践指导

### 8.1 选择合适的文件模式
| 操作类型 | 文件模式 | 特点 |
|----------|----------|------|
| 读取文本 | `'r'` 或 `'rt'` | 只读，文件必须存在 |
| 写入文本 | `'w'` 或 `'wt'` | 只写，覆盖已有文件 |
| 追加文本 | `'a'` 或 `'at'` | 追加，不覆盖已有内容 |
| 读取二进制 | `'rb'` | 只读二进制文件 |
| 写入二进制 | `'wb'` | 只写二进制文件 |
| 追加二进制 | `'ab'` | 追加二进制文件 |
| 读写文本 | `'r+'` | 读写，文件必须存在 |
| 读写文本（覆盖） | `'w+'` | 读写，覆盖已有文件 |
| 读写文本（追加） | `'a+'` | 读写，在文件末尾追加 |

### 8.2 处理大文件
当处理大文件时，应避免一次性读取整个文件，而是分块读取，以节省内存。

**示例**：
```python
# 分块读取大文件
chunk_size = 1024 * 1024  # 1MB
with open("large_file.txt", "r", encoding="utf-8") as file:
    while True:
        chunk = file.read(chunk_size)
        if not chunk:
            break
        # 处理chunk
        print(f"读取了{len(chunk)}个字符")
```

### 8.3 处理编码问题
在打开文件时，应指定正确的编码，避免出现编码错误。

**常见编码**：
- `'utf-8'`：通用编码，支持多种语言
- `'gbk'`：中文编码，用于Windows系统
- `'ascii'`：ASCII编码，只支持英文字符

**示例**：
```python
# 指定编码打开文件
with open("test.txt", "r", encoding="utf-8") as file:
    content = file.read()
    print(content)

# 处理编码错误
with open("test.txt", "r", encoding="utf-8", errors="ignore") as file:
    content = file.read()
    print(content)
```

### 8.4 常见错误和解决方法

#### 文件不存在错误（FileNotFoundError）
**错误示例**：
```python
with open("non_existent_file.txt", "r") as file:
    content = file.read()
# 报错：FileNotFoundError: [Errno 2] No such file or directory: 'non_existent_file.txt'
```

**解决方法**：
- 检查文件名或路径是否正确
- 使用正确的文件模式，如写入模式（`'w'`）或追加模式（`'a'`）会自动创建文件
- 使用`os.path.exists()`函数检查文件是否存在

#### 权限错误（PermissionError）
**错误示例**：
```python
with open("/system/file.txt", "w") as file:
    file.write("test")
# 报错：PermissionError: [Errno 13] Permission denied: '/system/file.txt'
```

**解决方法**：
- 检查是否有足够的权限
- 避免操作系统保护的文件或目录

#### 编码错误（UnicodeDecodeError）
**错误示例**：
```python
with open("test.txt", "r", encoding="ascii") as file:
    content = file.read()
# 报错：UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 0: ordinal not in range(128)
```

**解决方法**：
- 指定正确的编码，如`'utf-8'`
- 使用`errors="ignore"`或`errors="replace"`参数处理编码错误

#### 文件已关闭错误（ValueError）
**错误示例**：
```python
file = open("test.txt", "r")
content = file.read()
file.close()
content = file.read()  # 文件已关闭
# 报错：ValueError: I/O operation on closed file.
```

**解决方法**：
- 确保在文件关闭后不再操作文件
- 使用`with`语句自动管理文件资源

## 9. 总结

本章节介绍了Python的文件操作，包括：
- 文件的打开与关闭：`open()`函数、文件模式、`close()`方法、`with`语句
- 文件的读取：`read()`、`readline()`、`readlines()`方法
- 文件的写入：`write()`、`writelines()`方法
- 文件定位：`tell()`、`seek()`方法
- 文件和目录操作：`os`模块、`shutil`模块
- 实践指导：选择合适的文件模式、处理大文件、处理编码问题、常见错误和解决方法

通过学习这些内容，你已经掌握了Python文件操作的核心知识，可以处理各种类型的文件，实现数据的持久化存储和读取。接下来，我们将学习Python的异常处理，进一步提升你的编程能力。